{% extends "base.html" %}

{% block content %}
<style>
    /* Local styles to fix linter errors and clean up HTML */
    .chat-contact {
        display: block;
        padding: 10px;
        border-bottom: 1px solid #eee;
        color: #333;
        background-color: white;
        text-decoration: none;
    }
    .chat-contact:hover {
        background-color: #f9f9f9;
    }
    .chat-contact.active-chat {
        background-color: #f0f0f0;
        border-left: 4px solid var(--primary-gold);
    }
</style>

<div class="dashboard-header" style="margin-bottom: 0; padding-bottom: 10px;">
    <h1>Student Messages</h1>
    <a href="{{ url_for('counselor_dashboard') }}">&larr; Dashboard</a>
</div>

<div class="chat-container">
    
    <!-- Sidebar: List of Students -->
    <div class="chat-sidebar">
        <div class="chat-header">Conversations</div>
        <div style="padding: 10px;">
            {% if students %}
                {% for student in students %}
                    <!-- Logic moved to class attribute -->
                    <a href="{{ url_for('counselor_view_messages', student_id=student.id) }}" 
                       class="chat-contact {% if active_student and active_student.id == student.id %}active-chat{% endif %}">
                        <div style="font-weight: bold;">{{ student.username }}</div>
                        <small style="color: #666;">View Chat</small>
                    </a>
                {% endfor %}
            {% else %}
                <p style="padding: 10px; font-size: 0.9rem; color: #666;">No active conversations.</p>
            {% endif %}
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="chat-main">
        {% if active_student %}
            <div class="chat-header">
                Chat with <span class="text-gold">{{ active_student.username }}</span>
            </div>

            <div class="chat-messages">
                {% for msg in messages %}
                    <div class="message {% if msg.sender_id == current_user.id %}sent{% else %}received{% endif %}">
                        {{ msg.message }}
                        <span class="message-time">{{ msg.timestamp.strftime('%H:%M') }}</span>
                    </div>
                {% endfor %}
            </div>

            <form class="chat-input-area" method="POST" action="{{ url_for('counselor_view_messages', student_id=active_student.id) }}">
                <input type="text" name="message" class="form-control" placeholder="Type reply..." required autocomplete="off">
                <button type="submit" class="btn"><i class="fas fa-paper-plane"></i></button>
            </form>

        {% else %}
            <div style="flex: 1; display: flex; justify-content: center; align-items: center; color: #999;">
                <p>Select a conversation to reply.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}